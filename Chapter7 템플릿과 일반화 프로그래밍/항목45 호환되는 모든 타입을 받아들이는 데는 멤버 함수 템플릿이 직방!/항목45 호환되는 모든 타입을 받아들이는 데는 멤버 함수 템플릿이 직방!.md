# ν•­λ© 45: "νΈν™λλ” λ¨λ“  νƒ€μ…"μ„ λ°›μ•„λ“¤μ΄λ” λ°λ” λ©¤λ²„ ν•¨μ ν…ν”λ¦Ώμ΄ μ§λ°©! - μ‘μ„±μ: μ‹ λ™μ±

<aside>

# π” μ΄κ²ƒλ§μ€ μμ§€ λ§μ!

- νΈν™λλ” λ¨λ“  νƒ€μ…μ„ λ°›μ•„λ“¤μ΄λ” λ©¤λ²„ ν•¨μλ¥Ό λ§λ“¤λ ¤λ©΄ λ©¤λ²„ ν•¨μ ν…ν”λ¦Ώμ„ μ‚¬μ©ν•©μ‹λ‹¤.
- μΌλ°ν™”λ λ³µμ‚¬ μƒμ„± μ—°μ‚°κ³Ό μΌλ°ν™”λ λ€μ… μ—°μ‚°μ„ μ„ν•΄ λ©¤λ²„ ν…ν”λ¦Ώμ„ μ„ μ–Έν–λ‹¤ ν•λ”λΌλ„, λ³΄ν†µμ λ³µμ‚¬ μƒμ„±μμ™€ λ³µμ‚¬ λ€μ… μ—°μ‚°μλ” μ—¬μ „ν μ§μ ‘ μ„ μ–Έν•΄μ•Ό ν•©λ‹λ‹¤.
</aside>

### 1. λ°°κ²½: μ¤λ§νΈ ν¬μΈν„°μ μ•”μ‹μ  λ³€ν™ λ¬Έμ 

- **κΈ°λ³Έ ν¬μΈν„°**λ” μ—¬λ¬ μ•”μ‹μ  λ³€ν™μ΄ κ°€λ¥ν•¨

```cpp
class Top {};
class Middle : public Top {};
class Bottom : public Middle {};

Top* p1 = new Middle; // OK νμƒ -> κΈ°λ³Έ
Top* p2 = new Bottom; // OK
const Top* pct = p1;  // OK λΉ„μƒμ -> μƒμ
```

- ν•μ§€λ§ `SmartPtr<T>` μ²λΌ ν…ν”λ¦Ώ ν΄λμ¤λ΅ κ°μ‹Έλ©΄,
    
    `SmartPtr<Middle>` β†’ `SmartPtr<Top>` μΌλ΅μ λ³€ν™μ€ μλ™μΌλ΅ μ• λ¨.
    

```cpp
template<typename T>
class SmartPtr {};

SmartPtr<Middle> pm(new Middle);
SmartPtr<Top> pt = pm; // X
```

μ΄μ  : `SmartPtr<Middle>` κ³Ό `SmartPtr<Top>` μ€ μ™„μ „ν λ‹¤λ¥Έ νƒ€μ…μ΄κΈ° λ•λ¬Έ.

`SmartPtr<Derived>` β†’ `SmartPtr<Base>` λ³€ν™μ„ ν—μ©ν•λ ¤λ©΄

μƒμ„±μλ¥Ό μΌμΌμ΄ λ§λ“¤λ©΄ λ¨

```cpp
SmartPtr(const SmartPtr<Middle>& other);
SmartPtr(const SmartPtr<Bottom>& other);
SmartPtr(const SmartPtr<BelowBottom>& other);
...
```

ν΄λμ¤ κ³„μΈµμ΄ λμ–΄λ‚ μλ΅ μ΄λ° μƒμ„±μλ” **λ¬΄ν•ν λ§μ•„μ§.**

### 2. ν•΄κ²°μ±… : λ©¤λ²„ ν•¨μ ν…ν”λ¦Ώ (λ©¤λ²„ ν…ν”λ¦Ώ μƒμ„±μ)

- **λ‹¤λ¥Έ `SmartPtr<U>`λ΅λ¶€ν„° `SmartPtr<T>`λ¥Ό μƒμ„±ν•λ” μƒμ„±μ**λ¥Ό λ§λ“¤μ–΄μ•Ό ν•¨.

```cpp
template<typename T>
class SmartPtr {
public:
    template<typename U>
    SmartPtr(const SmartPtr<U>& other);
};
```

- μ„ μ½”λ“λ¥Ό κ°„λ‹¨ν λ§λ΅ ν’€μ–΄ λ³΄λ©΄ μ΄λ ‡λ‹¤
    - λ¨λ“  T νƒ€μ… λ° λ¨λ“  U νƒ€μ…μ— λ€ν•΄μ„, `SmartPtr<T>` κ°μ²΄κ°€ `SmartPtr<U>`λ΅λ¶€ν„° μƒμ„±λ  μ μλ‹¤λ” μ΄μ•ΌκΈ°
    - κ·Έ μ΄μ λ” `SmartPtr<U>`μ μ°Έμ΅°μλ¥Ό λ§¤κ°λ³€μλ΅ λ°›μ•„λ“¤μ΄λ” μƒμ„±μκ°€ `SmartPtr<T>` μ•μ— λ“¤μ–΄μκΈ° λ•λ¬Έ
    - μ΄λ° κΌ΄μ„ κ°€λ¦¬μΌ **μΌλ°ν™” λ³µμ‚¬ μƒμ„±μ(generalized copy constructor)**λΌκ³  λ¶€λ¦„

- μΌλ°ν™” λ³µμ‚¬ μƒμ„±μλ” `explicit`μΌλ΅ μ„ μ–Έλμ§€ μ•μ•λ‹¤
    - κΈ°λ³Έμ κ³µ ν¬μΈν„°λ” ν¬μΈν„° νƒ€μ… μ‚¬μ΄μ νƒ€μ… λ³€ν™(νμƒ β†’ κΈ°λ³Έ)μ΄ μ•”μ‹μ μΌλ΅ μ΄λ£¨μ–΄μ§€λ©° μΊμ¤ν…μ΄ ν•„μ”ν•μ§€ μ•κΈ° λ•λ¬Έμ—, μ¤λ§νΈ ν¬μΈν„°λ„ μ΄λ¥Ό ν‰λ‚΄λ‚΄λ”κ² λ§λ‹¤

- κ·Έλ°λ°, μ΄κ² Bottom β†’ Topλ„ λλ”λ°, Top β†’ Bottomλ„ λλ²„λ¦°λ‹¤
- μ‹¬μ§€μ–΄ `SmartPtr<double>` β†’ `SmartPtr<int>`κ°€ κ°€λ¥ν•΄λ²„λ¦°λ‹¤
    - κΈ°λ³Έμ κ³µ ν¬μΈν„°λ” int* μ—μ„ double*λ΅ μ§„ν–‰λλ” μ•”μ‹μ  λ³€ν™μ΄ κ°€λ¥ν•μ§€ μ•λ‹¤

- `auto_ptr` λ° `tr1::shared_ptr`μ—μ„ μ“°λ” λ°©λ²•μ„ κ·Έλ€λ΅ λ”°λΌμ„ SmartPtrλ„ get λ©¤λ²„ ν•¨μλ¥Ό ν†µν•΄ ν•΄λ‹Ή μ¤λ§νΈ ν¬μΈν„° κ°μ²΄μ— μμ²΄μ μΌλ΅ λ‹΄κΈ΄ κΈ°λ³Έμ κ³µ ν¬μΈν„°μ μ‚¬λ³Έμ„ λ°ν™ν•λ‹¤κ³  κ°€μ •ν•λ©΄, μ΄κ²ƒμ„ μ΄μ©ν•΄μ„ μƒμ„±μ ν…ν”λ¦Ώμ— μ°λ¦¬κ°€ μ›ν•λ” νƒ€μ… λ³€ν™ μ μ•½μ„ μ¤„ μ μμ„ κ²ƒ κ°™λ‹¤.

```cpp
template<typename T>
class SmartPtr {
public:
    template<typename U>
    SmartPtr(const SmartPtr<U>& other)
        : heldPtr(other.get()) {}
private:
    T* heldPtr;
};
```



- [1] `SmartPtr(const SmartPtr<U>& other)`
    - μƒμ„±μ μ„ μ–Έ λ¶€λ¶„
    - ν…ν”λ¦Ώ μƒμ„±μμ„
        - `SmartPtr` ν΄λμ¤ μμ²΄κ°€ `T`λΌλ” ν…ν”λ¦Ώ μΈμλ¥Ό κ°€μ§€κ³  μμ§€λ§,
            
            **μ΄ μƒμ„±μλ§ λ”°λ΅ λ‹¤λ¥Έ νƒ€μ… `U` λ¥Ό λ°›μ„ μ μκ²** ν• κ²ƒ

- [2] `: heldPtr(other.get())`
    - λ©¤λ²„ μ΄λ‹μ…λΌμ΄μ € κµ¬λ¬Έ
    - μƒμ„±μ λ³Έλ¬Έ `{}` μ•μ— λ“¤μ–΄κ°€κΈ° μ „μ—
        
        **λ©¤λ²„ λ³€μλ¥Ό μ΄κΈ°ν™”ν•λ” λ¬Έλ²•**
        
    - μΌλ°μ μΌλ΅ μƒμ„±μλ” μ΄λ ‡κ² μ”€
    - 
    
    ```cpp
    SmartPtr(const SmartPtr<U>& other) {
    	heldPtr = other.get();
    }
    ```
    
    ν•μ§€λ§ C++μ—μ„λ” λ©¤λ²„ λ³€μ μ΄κΈ°ν™”λ¥Ό μ΄λ‹μ…λΌμ΄μ € λ¦¬μ¤νΈμ—μ„ μ§μ ‘ ν•λ” κ±Έ κ¶μ¥
    
    κ·Έ μ΄μ λ”
    
    - μƒμ„±μ λ³Έλ¬Έμ— λ“¤μ–΄κ°€κΈ° μ „μ— μ΄κΈ°ν™”κ°€ λλ‚μ•Ό ν•¨
    - λ³µμ‚¬λ‚ λ””ν΄νΈ μƒμ„± λ€μ‹  μ›ν•λ” κ°’μΌλ΅ λ°”λ΅ μ΄κΈ°ν™” κ°€λ¥
    - `const`λ‚ `reference` λ©¤λ²„λ„ μ΄ λ°©μ‹μΌλ΅λ§ μ΄κΈ°ν™” κ°€λ¥
    
    κ·Έλμ„ μ΄λ ‡κ² μ“°λ”κ±°μ„
    
    ```cpp
    SmartPtr(const SmartPtr<U>& other)
    	: heldPtr(other.get()) // <- heldPtrλ¥Ό other.get()μΌλ΅ μ΄κΈ°ν™”
    {}
    ```
    
- [3] `other.get()`
    - otherκ°€ κ°€μ§„ λ‚΄λ¶€ ν¬μΈν„°λ¥Ό λ°ν™ν•λ” ν•¨μ (μ΄λ° ν•¨μκ°€ μλ‹¤κ³  κ°€μ •)
    - λ³΄ν†µ μ¤λ§νΈ ν¬μΈν„°λ” λ‚΄λ¶€μ— `T*` λ¥Ό μ €μ¥ν•κ³  μκ³ ,
        
        κ·Έκ±Έ μ–»κΈ° μ„ν•΄ `get()` λ©”μ„λ“λ¥Ό μ κ³µν•¨
        
    
    ```cpp
    template<typename T>
    class SmartPtr {
    public:
        T* get() const { return heldPtr; }  // λ‚΄λ¶€ ν¬μΈν„° λ¦¬ν„΄
        ...
    private:
        T* heldPtr;
    };
    ```
    

**μ •λ¦¬**

β€λ‹¤λ¥Έ νƒ€μ…μ `SmartPtr<U>` μ—μ„ λ‚΄λ¶€ ν¬μΈν„°λ¥Ό κΊΌλ‚΄ (`get()` ),

λ‚΄ νƒ€μ…μ λ‚΄λ¶€ ν¬μΈν„°(`heldPtr`)λ¥Ό κ·Έκ±Έλ΅ μ΄κΈ°ν™”ν•΄λΌβ€

μ΄μ  U*μ—μ„ T*λ΅ μ§„ν–‰λλ” μ•”μ‹μ  λ³€ν™μ΄ κ°€λ¥ν•  λ•λ§ μ»΄νμΌ μ—λ¬κ°€ λ°μƒν•μ§€ μ•λ”λ‹¤.

---

### 3. `shared_ptr`λ΅ λ³΄λ” μΌλ°ν™” λ³µμ‚¬ μƒμ„±μ

TR1μ—μ„ tr1::shared_ptr ν…ν”λ¦Ώμ΄ μ–΄λ–»κ² λ‚μ™€ μλ”μ§€ ν• λ² μ‚΄ν΄λ³΄μ.

```cpp
template<class T>
class shared_ptr {
public:
    template<class Y>
    explicit shared_ptr(Y* p);                    // κΈ°λ³Έ ν¬μΈν„°λ΅λ¶€ν„° μƒμ„±
    template<class Y>
    shared_ptr(shared_ptr<Y> const& r);           // λ‹¤λ¥Έ shared_ptrλ΅λ¶€ν„° μƒμ„±
    template<class Y>
    explicit shared_ptr(weak_ptr<Y> const& r);    // weak_ptrλ΅λ¶€ν„° μƒμ„±
    template<class Y>
    explicit shared_ptr(auto_ptr<Y>& r);          // auto_ptrλ΅λ¶€ν„° μƒμ„±

    template<class Y>
    shared_ptr& operator=(shared_ptr<Y> const& r); // λ‹¤λ¥Έ shared_ptrλ΅λ¶€ν„° λ€μ…
    template<class Y>
    shared_ptr& operator=(auto_ptr<Y>& r);        // auto_ptrλ΅λ¶€ν„° λ€μ…
};

```

- [1] μΌλ°ν™” λ³µμ‚¬ μƒμ„±μλ¥Ό μ μ™Έν•κ³  λ¨λ“  μƒμ„±μκ°€ `explicit`λ΅ μ„ μ–Έλμ–΄ μλ‹¤
    - shared_ptrλ΅ λ§λ“  μ–΄λ–¤ νƒ€μ…μΌλ΅λ¶€ν„° λ λ‹¤λ¥Έ νƒ€μ…μΌλ΅ μ§„ν–‰λλ” **μ•”μ‹μ  λ³€ν™μ€ ν—μ©λμ§€λ§,**
        
        κΈ°λ³Έμ κ³µ ν¬μΈν„° νΉμ€ λ‹¤λ¥Έ μ¤λ§νΈ ν¬μΈν„° νƒ€μ…μΌλ΅λ¶€ν„° λ³€ν™λλ” κ²ƒμ€ λ§‰κ² λ‹¤ (λ…μ‹μ  λ³€ν™μ€ ν—μ©)
        
    
    | μƒμ„±μ μΆ…λ¥ | μ•”μ‹μ  λ³€ν™ ν—μ© μ—¬λ¶€ | μ΄μ  |
    | --- | --- | --- |
    | `shared_ptr(shared_ptr<Y> const&)` | β… ν—μ© | `shared_ptr<Derived>` β†’ `shared_ptr<Base>`λ” μμ—°μ¤λ¬μ΄ λ³€ν™ |
    | `shared_ptr(Y* p)` | β μ°¨λ‹¨ | `int*` β†’ `shared_ptr<int>` κ°™μ€ μλ™ λ³€ν™μ€ μ„ν—ν•λ‹κΉ λ…μ‹μ  μƒμ„±λ§ ν—μ© |
    | `shared_ptr(auto_ptr<Y>& r)` | β μ°¨λ‹¨ | μμ› μ΄μ „(auto_ptr)μ€ μ„ν—ν•λ―€λ΅ λ…μ‹μ μ΄μ–΄μ•Ό ν•¨ |
- [2] λ©¤λ²„ ν•¨μ ν…ν”λ¦Ώμ΄ μ–Έμ–΄ κ·μΉ™μ„ λ°”κΎΈμ§„ μ•λ”λ‹¤
    - μ±…μ—μ„ κ°•μ΅°ν•λ” λ¶€λ¶„μ€
    
    > β€λ©¤λ²„ ν•¨μ ν…ν”λ¦Ώμ„ μ„ μ–Έν–λ‹¤κ³  ν•΄μ„ μ»΄νμΌλ¬κ°€ μλ™μΌλ΅ λ§λ“¤μ–΄μ£Όλ” λ³µμ‚¬ μƒμ„±μκ°€ μ‚¬λΌμ§€λ” κ±΄ μ•„λ‹λ‹¤.β€
    > 
    
    μ¦‰,
    
    - **λ³µμ‚¬ μƒμ„±μ (λΉ„ν…ν”λ¦Ώ)**
    - **μΌλ°ν™” λ³µμ‚¬ μƒμ„±μ (ν…ν”λ¦Ώ)**
    
    μ΄ λ‘μ€ μ„λ΅ λ³„κ°λ‹¤
    
    μλ¥Ό λ“¤μ–΄,
    
    ```cpp
    template<class T>
    class shared_ptr {
    public:
        shared_ptr(shared_ptr const& r);           // λ³΄ν†µ λ³µμ‚¬ μƒμ„±μ
        template<class Y>
        shared_ptr(shared_ptr<Y> const& r);        // μΌλ°ν™” λ³µμ‚¬ μƒμ„±μ
    };
    ```
    
    μ΄λ ‡κ² ν•λ©΄
    
    - `shared_ptr<int>` β† `shared_ptr<int>` β†’ **λ³µμ‚¬ μƒμ„±μ** νΈμ¶
    - `shared_ptr<Base>` β† `shared_ptr<Derived>` β†’ **ν…ν”λ¦Ώ μƒμ„±μ** νΈμ¶
    
    μ¦‰,
    
    νƒ€μ…μ΄ μ™„μ „ν λ™μΌν•λ©΄ λ³µμ‚¬ μƒμ„±μ, νƒ€μ…μ΄ λ‹¬λΌλ„ λ³€ν™μ΄ κ°€λ¥ν•λ©΄ ν…ν”λ¦Ώ μƒμ„±μκ°€ μ‚¬μ©λ¨
    
- [3] κ°™μ€ λ…Όλ¦¬κ°€ λ€μ… μ—°μ‚°μμ—λ„ μ μ©
    
    ```cpp
    shared_ptr& operator=(shared_ptr const& r);        // λ™μΌ νƒ€μ… λ€μ…
    template<class Y>
    shared_ptr& operator=(shared_ptr<Y> const& r);     // λ‹¤λ¥Έ νƒ€μ… λ€μ…
    ```
    
    μ΄λ ‡κ² λ‘ λ²„μ „μ΄ μμ–΄μ•Ό ν•λ‹¤
    
    ν…ν”λ¦Ώλ§ μ„ μ–Έν•λ©΄ λ™μΌ νƒ€μ… κ°„ λ€μ…(`sp = sp2`)μ΄ μ• λ  μ μλ‹¤